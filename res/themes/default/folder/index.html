<!DOCTYPE html>
#set( $trackColor = "#FF0000" )
#set( $trackOpacity = "0.5" )
#set( $trackWeight = "5" )
#set( $thumbSize = $conf.dims['thumb-size'] )
#set( $previewSize = $conf.dims['preview-size'] )
#set( $subfolders = $folder.subfolders )
#set( $tracks = $folder.tracks )
#set( $pictures = $folder.pictures )
#set( $geopics = [] )
#foreach( $pic in $pictures )
    #if( $pic.gpsData )
        #set( $dummy = $geopics.add($pic) )
    #end
#end
<html class="index">
    <head>
        <title>$esc.html($folder.title)</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="${base}css/normalize.css">
        <link rel="stylesheet" href="${base}css/style.css">
    </head>
    <body>
        <header>
            <div class="left-btns">
                #if($prev)
                <a class="prev-btn" href="../$esc.url($prev)/index.html"><span>$prev</span></a>
                #end
                #if($folder.parent)
                <a class="up-btn" href="${base}${folder.parent.path}index.html"><span>${folder.parent.name}</span></a>
                #end
            </div>
            <h1>$esc.html($folder.title)</h1>
            <div class="right-btns">
                #if($next)
                <a class="next-btn" href="../$esc.url($next)/index.html"><span>$next</span></a>
                #end
            </div>
        </header>
        <div class="wrap">
            #if( !$subfolders.empty )
            <nav class="folders">
                <ul>
                #foreach( $sub in $subfolders )
                <li id="fld$sub.id"><a href="$esc.url($sub.name)/index.html">$esc.html($sub.title)</a></li>
                #end
                </ul>
            </nav>
            #end
            <div>
                #if( not $geopics.empty or not $tracks.empty )
                <div class="map" id="map"></div>
                #end
                #if( !$pictures.empty )
                <nav class="thumbs">
                    #foreach( $pic in $pictures )
                    <figure id="pic$pic.id">
                        #set($height = $math.round($thumbSize.height))
                        #set($width = $pic.width * $thumbSize.height / $pic.height)
                        #set($width = $math.round($width))
                        <a href="preview/${esc.url($pic.name)}.html"><img src="thumb/$esc.url($pic.name)" width="$width" height="$height" title="$esc.html($pic.name)"></a>
                        <figcaption>$esc.html($pic.name)</figcaption>
                    </figure>
                    #end
                </nav>
                #end
            </div>
        </div>
        #if( not $geopics.empty or not $tracks.empty )
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&language=fr&libraries=geometry"></script>
        <script type="text/javascript">
            window.onload = function() {
                var paths, path, tracks, track, markers, marker, bounds, pt,
                        i, j, mapOptions, map, builder;
                paths = [
                #foreach( $track in $tracks )
                    google.maps.geometry.encoding.decodePath("$esc.javascript(track.encoded)"),
                #end
                ];
                tracks = [];
                for (i = 0; i < paths.length; ++i) {
                    path = paths[i];
                    for (var j = 0; j < path.length; ++j) {
                        pt = path[j];
                        if (bounds) {
                            bounds.extend(pt);
                        } else {
                            bounds = new google.maps.LatLngBounds(pt,pt);
                        }
                    }
                    tracks.push(new google.maps.Polyline({
                        path: path,
                        strokeColor: '${trackColor}',
                        strokeOpacity: ${trackOpacity},
                        strokeWeight: ${trackWeight}
                    }));
                }
                markers = [
                #foreach( $pic in $geopics )
                    {
                        position: new google.maps.LatLng($pic.gpsData.latitude,$pic.gpsData.longitude),
                        info: new google.maps.InfoWindow({
                            content: '<a href="preview/${esc.url($pic.name)}.html"><img src="thumb/$esc.url($pic.name)" height="$math.round($thumbSize.height)" title="$esc.html($pic.name)"></a>',
                        }),
                    },
                #end
                ];
                for (var i = 0; i < markers.length; ++i) {
                    pt = markers[i].position;
                    if (bounds) {
                        bounds.extend(pt);
                    } else {
                        bounds = new google.maps.LatLngBounds(pt,pt);
                    }
                }
                mapOptions = {
                    zoom: 8,
                    center: bounds.getCenter(),
                    mapTypeId: google.maps.MapTypeId.TERRAIN
                };
                map = new google.maps.Map(document.getElementById("map"),
                        mapOptions);
                for (i = 0; i < tracks.length; ++i) {
                    track = tracks[i];
                    track.setMap(map);
                }
                for (i = 0; i < markers.length; ++i) {
                    marker = new google.maps.Marker(markers[i]);
                    marker.setMap(map);
                    google.maps.event.addListener(marker, 'click', function() {
                        this.info.open(map, this);
                    });
                }
                map.fitBounds(bounds);
            }
        </script>
        #end
    </body>
</html>
