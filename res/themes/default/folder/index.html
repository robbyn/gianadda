<!DOCTYPE html>
#set( $trackColor = "#FF0000" )
#set( $trackOpacity = "0.5" )
#set( $trackWeight = "5" )
#set( $thumbSize = $conf.dims['thumb-size'] )
#set( $previewSize = $conf.dims['preview-size'] )
#set( $subfolders = $folder.subfolders )
#set( $tracks = $folder.tracks )
#set( $pictures = $folder.pictures )
#set( $geopics = [] )
#foreach( $pic in $pictures )
    #if( $pic.gpsData )
        #set( $dummy = $geopics.add($pic) )
    #end
#end
#set( $subtracks = [] )
#foreach( $sub in $subfolders )
    #foreach( $tr in $sub.tracks )
        #set( $dummy = $subtracks.add($tr) )
    #end
#end
#set( $services = ["facebook","twitter","gplus","linkedin","email"] )
#set( $vars = {} )
#set( $dummy = $vars.put("url", $folder.url) )
<html class="index">
    <head>
        <title>$esc.html($folder.title)</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="${base}css/normalize.css">
        <link rel="stylesheet" href="${base}css/style.css">
        #if($folder.isRoot())
        <link rel="alternate" type="application/rss+xml" href="${base}feed.rss" />
        #end
    </head>
    <body>
        <header>
            <div class="left-btns">
                #if($prev)
                <a class="prev-btn" href="../$esc.url($prev)/index.html"><span>$prev</span></a>
                #end
                #if($folder.parent)
                <a class="up-btn" href="${base}${folder.parent.path}index.html"><span>${folder.parent.name}</span></a>
                #end
            </div>
            <h1>$esc.html($folder.title)</h1>
            <div class="right-btns">
                #if($next)
                <a class="next-btn" href="../$esc.url($next)/index.html"><span>$next</span></a>
                #end
            </div>
        </header>
        <div class="wrap">
            #if( not $geopics.empty or not $tracks.empty or not $subtracks.empty )
            <div class="map" id="map"></div>
            #end
            #foreach( $track in $tracks )
            <div class="profile">
                <div class="chart">$profile.svg($track.points,800,150)</div>
                #set( $sum = $profile.summary($track.points) )
                #set( $maps = $profile.swissMaps($track.points) )
                <table cellspacing="4" cellpadding="0" class="summary">
                    <tbody>
                        <tr>
                            <th>Elevation min/max:</th>
                            <td>${fmt.formatNumber($sum.minElevation,'#,##0')}m</td>
                            <td>${fmt.formatNumber($sum.maxElevation,'#,##0')}m</td>
                        </tr>
                        <tr>
                            <th>Ascent/descent:</th>
                            <td>+${fmt.formatNumber($sum.ascent,'#,##0')}m</td>
                            <td>-${fmt.formatNumber($sum.descent,'#,##0')}m</td>
                        </tr>
                        <tr>
                            <th>Distance:</th>
                            <td>${fmt.formatNumber($sum.distance,'#,##0')}m</td>
                            <td></td>
                        </tr>
                        <tr>
                            <th>Maps:</th>
                            <td class="maps" colspan="2">
#set( $first = true )
#foreach ( $map in $maps )#if( $first )#set( $first = false )#else, #{end}$map#end
                            </td>
                        </tr>
                     </tbody>
                </table>
            </div>
            #end
            #if( !$pictures.empty )
            <nav class="thumbs">
                #foreach( $pic in $pictures )
                <figure id="pic$pic.id">
                    #set($height = $math.round($thumbSize.height))
                    #set($width = $pic.width * $thumbSize.height / $pic.height)
                    #set($width = $math.round($width))
                    <a href="preview/${esc.url($pic.name)}.html"><img src="thumb/$esc.url($pic.name)" width="$width" height="$height" title="$esc.html($pic.descriptionOrName)"></a>
                    <figcaption>$esc.html($pic.descriptionOrName)</figcaption>
                </figure>
                #end
            </nav>
            #end
            #if( !$subfolders.empty )
            <nav class="folders">
                <ul>
                #foreach( $sub in $subfolders )
                <li id="fld$sub.id"><a href="$esc.url($sub.name)/index.html">$esc.html($sub.title)</a></li>
                #end
                </ul>
            </nav>
            #end
            #if( $folder.body )
            <div class="body">
                <div class="content">
                $folder.body
                </div>
            </div>
            #end
            <div class="share">
            #foreach( $sv in $services )
                <a href="$share.makeUrl($sv,$vars)" class="icon-${sv}" target="_blank"></a>
            #end
            </div>
        </div>
#if( $folder.analyticsId )
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '${folder.analyticsId}', 'auto');
  ga('send', 'pageview');
</script>
#end
        #if( not $geopics.empty or not $tracks.empty or not $subtracks.empty )
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&language=fr&libraries=geometry"></script>
        <script type="text/javascript">
            function setupAdjust(div, map, bounds) {
                var oldWidth = div.offsetWidth, oldHeight = div.offsetHeight;
                setInterval(function() {
                    var width = div.offsetWidth, height = div.offsetHeight;
                    if (width != oldWidth || height != oldHeight) {
                        oldWidth = width;
                        oldHeight = height;
                        google.maps.event.trigger(map, 'resize');
                        map.fitBounds(bounds);
                 }
                }, 100);
            }

            window.onload = function() {
                var paths, path, tracks, track, markers, marker, bounds, pt,
                        i, j, mapOptions, div, map, builder;
                var photoIcon = "${base}css/img/photo.png",
                    trackIcon = "${base}css/img/footprint.png";
                paths = [
                #foreach( $track in $tracks )
                    google.maps.geometry.encoding.decodePath("$esc.javascript($track.encoded)"),
                #end
                ];
                tracks = [];
                for (i = 0; i < paths.length; ++i) {
                    path = paths[i];
                    for (var j = 0; j < path.length; ++j) {
                        pt = path[j];
                        if (bounds) {
                            bounds.extend(pt);
                        } else {
                            bounds = new google.maps.LatLngBounds(pt,pt);
                        }
                    }
                    tracks.push(new google.maps.Polyline({
                        path: path,
                        strokeColor: '${trackColor}',
                        strokeOpacity: ${trackOpacity},
                        strokeWeight: ${trackWeight}
                    }));
                }
                markers = [
                #foreach( $pic in $geopics )
                    {
                        position: new google.maps.LatLng($pic.gpsData.latitude,$pic.gpsData.longitude),
                        icon: photoIcon,
                        info: new google.maps.InfoWindow({
                            content: '<a href="preview/${esc.url($pic.name)}.html"><img src="thumb/$esc.url($pic.name)" height="$math.round($thumbSize.height)" title="$esc.html($pic.name)"></a>',
                        }),
                    },
                #end
                #foreach( $tr in $subtracks )
                    {
                        position: new google.maps.LatLng($tr.center.lat,$tr.center.lng),
                        icon: trackIcon,
                        info: new google.maps.InfoWindow({
                            content: '<a href="${esc.url($tr.folder.name)}/index.html">${esc.html($tr.folder.title)}</a>',
                        }),
                    },
                #end
                ];
                for (var i = 0; i < markers.length; ++i) {
                    pt = markers[i].position;
                    if (bounds) {
                        bounds.extend(pt);
                    } else {
                        bounds = new google.maps.LatLngBounds(pt,pt);
                    }
                }
                mapOptions = {
                    zoom: 8,
                    center: bounds.getCenter(),
                    mapTypeId: google.maps.MapTypeId.TERRAIN,
                    scrollwheel: false
                };
                div = document.getElementById("map");
                map = new google.maps.Map(div, mapOptions);
                for (i = 0; i < tracks.length; ++i) {
                    track = tracks[i];
                    track.setMap(map);
                }
                for (i = 0; i < markers.length; ++i) {
                    marker = new google.maps.Marker(markers[i]);
                    marker.setMap(map);
                    google.maps.event.addListener(marker, 'click', function() {
                        this.info.open(map, this);
                    });
                }
                map.fitBounds(bounds);
                setupAdjust(div, map, bounds);
            }
        </script>
        #end
    </body>
</html>
